name: buildlunahook
on:
  workflow_dispatch:

jobs:
  build_xp:
    runs-on: windows-latest
    permissions:
      id-token: write
      attestations: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: GuillaumeFalourd/setup-windows10-sdk-action@v2
        with:
          sdk-version: 26100
      - run: python src/scripts/build_lunahook.py build x86 0 xp
      - run: python src/scripts/packlunahook.py

      - uses: actions/upload-artifact@v4
        with:
          # winxp 빌드 결과물 중 'x86' 폴더만 업로드합니다.
          # build_lunahook.py build x86 0 xp 명령어가 src/cpp/LunaHook/builds/x86/Release를 생성한다고 가정합니다.
          name: winxp-x86-output 
          path: src/cpp/LunaHook/builds/x86 
  
  # build_plugin: (주석 처리된 부분은 그대로 둡니다)
  #   runs-on: windows-latest
  #   strategy:
  #     matrix:
  #       include:
  #         - bits: 32
  #           qtarch: win32_msvc2019
  #         - bits: 64
  #           qtarch: win64_msvc2019_64
  #   permissions:
  #     id-token: write
  #     attestations: write
  #     contents: write
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: GuillaumeFalourd/setup-windows10-sdk-action@v2
  #       with:
  #         sdk-version: 22621
      
  #     - uses: jurplel/install-qt-action@v3.3.0
  #       with:
  #         version:     5.15.2
  #         host:        windows
  #         target:      desktop
  #         arch:        ${{ matrix.qtarch }}
  #         dir:         ${{ runner.temp }}
  #         setup-python: true
  #     - run: python src/scripts/build_lunahook.py plugin ${{ matrix.bits }}
  #     - run: python src/scripts/packlunahook.py

  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: plugin${{ matrix.bits }}
  #         path: src/cpp/LunaHook/builds/plugin${{ matrix.bits }}.zip
  #     - uses: softprops/action-gh-release@v2
  #       with:
  #         tag_name: LunaHook
  #         files: src/cpp/LunaHook/builds/plugin${{ matrix.bits }}.zip
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  build_x:
    runs-on: windows-latest
    strategy:
      matrix:
        bits: [64]
    permissions:
      id-token: write
      attestations: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: GuillaumeFalourd/setup-windows10-sdk-action@v2
        with:
          sdk-version: 26100
      - run: python src/scripts/build_lunahook.py build x64 0 win7

      - uses: actions/upload-artifact@v4
        with:
          # x64 빌드 결과물 중 'x64' 폴더만 업로드합니다.
          # build_lunahook.py build x64 0 win7 명령어가 src/cpp/LunaHook/builds/x64/Release를 생성한다고 가정합니다.
          name: x64-output 
          path: src/cpp/LunaHook/builds/x64 
  
  build:
    runs-on: windows-latest
    needs: [build_x,build_xp]
    steps:
      - uses: actions/checkout@v4
      - name: Download x64 artifact
        uses: actions/download-artifact@v4
        with:
          # x64 아티팩트를 'build/64' 경로에 다운로드하여 'build/64/Release'를 만듭니다.
          name: x64-output 
          path: build/64 
      - name: Download winxp artifact
        uses: actions/download-artifact@v4
        with:
          # winxp 아티팩트를 'build/winxp' 경로에 다운로드하여 'build/winxp/Release'를 만듭니다.
          name: winxp-x86-output 
          path: build/winxp 
      - name: List downloaded artifacts for debugging
        run: |
          Get-ChildItem -Recurse -Path build | Select-Object -ExpandProperty FullName
      - run: python src/scripts/build_lunahook.py merge
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: LunaHook
          # 'build_lunahook.py merge' 스크립트가 최종 결과물을 어디에 두는지에 따라 이 'files' 경로를 확인해야 합니다.
          # 만약 병합된 결과물이 여전히 'src/cpp/LunaHook/builds'에 저장된다면 이 경로는 그대로 유지됩니다.
          files: src/cpp/LunaHook/builds/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
